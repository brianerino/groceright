<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Notifications – GroceRight</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ===================== Global Styles ===================== */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: rgb(177, 216, 183);
            margin: 0;
            min-height: 100vh;
        }

        /* ===================== Header Layout ===================== */
        .header {
            background: white;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-end;
        }

        .header-left img {
            height: 90px;
            object-fit: contain;
        }

        .header-right {
            display: flex;
            flex-direction: row;
            gap: 20px;
            justify-content: flex-end;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        /* ================== Navigation Button =================== */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            align-items: flex-end;
        }

        .button-group button {
            padding: 8px 16px;
            font-size: 1rem;
            border: none;
            background-color: #0044cc;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            height: 42px;
        }

        .button-group button:hover {
            background-color: #003399;
        }

        .btn-primary {
            background: #0044cc;
            border: none;
        }

        .btn-primary:hover {
            background: #003399;
        }

        /* ================= Container ================== */
        .container {
            max-width: 800px;
            margin: auto;
        }

        /* ================ Tab Styles ================ */
        .tabs {
            margin-bottom: 1rem;
        }

        .tabs button {
            border: none;
            background: transparent;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1rem;
            color: #0044cc;
        }

        .tabs button.active {
            border-bottom: 3px solid #0044cc;
            font-weight: bold;
        }

        /* ============== Notification Cards ============== */
        .notif-card {
            background: white;
            margin-bottom: 0.75rem;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notif-card.unresolved {
            /* Highlight unresolved in red */
            border-left: 4px solid #d9534f;
        }

        .notif-card.resolved {
            /* Dim resolved items */
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <!-- ================= Header ================= -->
    <div class="header">
        <div class="header-left">
            <img src="/static/images/logo.png" alt="GroceRight Logo">
        </div>
        <div class="header-right">
            <div class="button-group">
                <!-- Back to dashboard navigation -->
                <button onclick="location.href='/index'">← Back to Dashboard</button>
            </div>
        </div>
    </div>

    <!-- ================= Main Container ================= -->
    <div class="container">
        <!-- ================= Tabs ================= -->
        <div class="tabs" style="position: relative;">
            <!-- Unresolved vs All toggle -->
            <button id="tab-unresolved" class="active">Unresolved</button>
            <button id="tab-all">All</button>

        </div>

        <!-- ================= Notification List ================= -->
        <!-- Populated dynamically via JS -->
        <div id="notifList"></div>
    </div>

    <script>
        // =====================================================================
        // In-Memory Data & Persistence Key
        // =====================================================================
        let allNotifs = [];

        const STORAGE_KEY = 'resolvedNotifications';
        // Load previously resolved IDs from localStorage
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let resolvedSet = new Set(saved);

        // =====================================================================
        // Initial Data Fetch
        // - Load notifications from API, seed resolved flags, then render.
        // =====================================================================
        fetch('/api/notifications')
            .then(r => r.json())
            .then(data => {
                // Map each notification and mark resolved state
                allNotifs = data.map(n => ({
                    ...n,
                    resolved: resolvedSet.has(n.product_id)
                }));
                renderList();
            })
            .catch(err => console.error(err));

        // =====================================================================
        // Tab Click Handlers
        // - Switch active tab and re-render list on click.
        // =====================================================================
        document.getElementById('tab-unresolved').onclick = () => {
            toggleTab('unresolved');
        };
        document.getElementById('tab-all').onclick = () => {
            toggleTab('all');
        };

        /**
     * Switch active tab and refresh notification list.
     * @param {string} tab - 'unresolved' or 'all'
     */
        function toggleTab(tab) {
            // Update active class on both buttons
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderList();
        }

        // =====================================================================
        // Render Notification Cards
        // - Filters based on current tab, builds DOM elements.
        // =====================================================================
        function renderList() {
            const showingAll = document.getElementById('tab-all').classList.contains('active');
            const list = document.getElementById('notifList');
            list.innerHTML = '';

            const toShow = allNotifs.filter(n => showingAll || !n.resolved);
            if (!toShow.length) {
                // Empty state
                list.innerHTML = `<p class="text-muted">No notifications</p>`;
                return;
            }

            toShow.forEach(n => {
                // Create card container
                const card = document.createElement('div');
                card.className = `notif-card ${n.resolved ? 'resolved' : 'unresolved'}`;
                card.innerHTML = `
                    <div>
                        <strong>${n.product_name}</strong>
                        &ndash; only ${n.quantity} left in stock
                    </div>
                    <div>
                        <input type="checkbox" id="chk-${n.product_id}" ${n.resolved ? 'checked' : ''}/>
                        <label for="chk-${n.product_id}">Resolved</label>
                    </div>
                `;

                // Checkbox toggle: update in-memory, set, localStorage, then re-render
                const checkbox = card.querySelector('input');
                checkbox.onchange = e => {
                    n.resolved = e.target.checked;
                    if (n.resolved) resolvedSet.add(n.product_id);
                    else resolvedSet.delete(n.product_id);
                    // Persist updated set
                    localStorage.setItem(STORAGE_KEY, JSON.stringify([...resolvedSet]));
                    renderList();
                };
                list.appendChild(card);
            });
        }
    </script>
</body>

</html>